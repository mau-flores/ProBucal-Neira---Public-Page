<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reserva de Citas</title>
    <link rel="stylesheet" href="css/reserva.css" />
  </head>
  <body>
    <div class="container">
      <h2>Reserva de citas</h2>
      <form>
        <div class="form-grid">
          <div
            class="form-group full-width"
            style="display: flex; align-items: center; gap: 10px"
          >
            <label for="dni" style="min-width: 60px">DNI</label>
            <input
              type="text"
              id="dni"
              placeholder="DNI"
              style="flex: 1; min-width: 0"
            />
            <button type="button" id="btnBuscarDNI" class="btn btn-submit">
              Buscar
            </button>
          </div>
          <div class="form-group">
            <label for="nombres">Nombres</label>
            <input type="text" id="nombres" placeholder="Nombres" />
          </div>
          <div class="form-group">
            <label for="apellidos">Apellidos</label>
            <input type="text" id="apellidos" placeholder="Apellidos" />
          </div>
          <div class="form-group">
            <label for="fecha">Fecha</label>
            <input type="date" id="fecha" />
          </div>
          <div class="form-group">
            <label for="motivo">Motivo</label>
            <select id="motivo">
              <option disabled selected>Seleccione</option>
              <option>Consulta general</option>
              <option>Control</option>
              <option>Emergencia</option>
            </select>
          </div>
          <div class="form-group full-width">
            <label for="otros">Datos adicionales</label>
            <textarea
              id="otros"
              placeholder="Datos que el médico debe saber"
            ></textarea>
          </div>
        </div>
        <div class="actions">
          <button
            type="button"
            class="btn btn-cancel"
            onclick="window.location.href='index.html'"
          >
            Cancelar
          </button>
          <button type="submit" class="btn btn-submit">Enviar</button>
        </div>
      </form>
    </div>
    <!-- ===================================================== -->
    <!--  SCRIPT PARA BUSCAR DNI Y AUTOCOMPLETAR DATOS         -->
    <!-- ===================================================== -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const inputDni = document.getElementById("dni");
        const inputNombres = document.getElementById("nombres");
        const inputApellidos = document.getElementById("apellidos");
        const btnBuscarDNI = document.getElementById("btnBuscarDNI");

        const TOKEN =
          "6414ef08e394bb632202d712779a396607336e19c626dec3dcc085cc86340053";

        btnBuscarDNI.addEventListener("click", async () => {
          const dni = inputDni.value.trim();

          if (dni.length !== 8 || !/^\d+$/.test(dni)) {
            alert("Ingrese un DNI válido de 8 dígitos.");
            return;
          }

          btnBuscarDNI.textContent = "Buscando...";
          btnBuscarDNI.disabled = true;

          try {
            const res = await fetch("https://apiperu.dev/api/dni", {
              method: "POST",
              headers: {
                Accept: "application/json",
                "Content-Type": "application/json",
                Authorization: "Bearer " + TOKEN,
              },
              body: JSON.stringify({ dni }),
            });

            const data = await res.json();

            if (!data.success) {
              alert("No se encontró información para este DNI.");
              return;
            }

            // Rellenar campos con los datos obtenidos
            inputNombres.value = data.data.nombres ?? "";
            inputApellidos.value = `${data.data.apellido_paterno ?? ""} ${
              data.data.apellido_materno ?? ""
            }`.trim();
          } catch (error) {
            console.error("Error consultando la API:", error);
            alert("Error al consultar el DNI.");
          } finally {
            btnBuscarDNI.textContent = "Buscar";
            btnBuscarDNI.disabled = false;
          }
        });
      });
    </script>
    <script>
      document.querySelector("form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const datos = {
          dni: document.getElementById("dni").value.trim(),
          nombres: document.getElementById("nombres").value.trim(),
          apellidos: document.getElementById("apellidos").value.trim(),
          fecha: document.getElementById("fecha").value,
          motivo: document.getElementById("motivo").value,
          otros: document.getElementById("otros").value.trim(),
        };

        const res = await fetch("php/guardar_reserva.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(datos),
        });

        const data = await res.json();

        if (data.success) {
          alert("Reserva registrada correctamente");
          window.location.href = "index.html";
        } else {
          alert("Error: " + data.error);
        }
      });
    </script>
  </body>
</html>
